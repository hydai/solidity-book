# EIP-663 新增 SWAPN、DUPN 和 EXCHANGE 指令

## 1. 簡介
- 這個提案讓在 EVM 做堆疊操作更方便。
- 原本 EVM 只能輕鬆存取堆疊前 16 個位置，造成編譯合約時比較麻煩。
- EIP-663 希望提供更直觀和有效率的解決方式。

## 2. 傳統堆疊操作的挑戰
- EVM 堆疊可以放多達 1024 個值，但只能輕鬆操作前 16 個。
- 若要更深位置，就得用許多指令組合，容易出錯，也會增加合約複雜度。

## 3. EIP-663 的解法
- 可操作堆疊最多 256 個位置，增加彈性。
- 提供三個新指令：DUPN、SWAPN、EXCHANGE，減少多餘步驟。

## 4. 新指令的執行細節
- 參數都是 8-bit。
- DUPN & SWAPN：可任意操作與頂端相隔 1~256 深度的物件。
- EXCHANGE：用參數前後 4-bit 代表要交換的堆疊位置。
- Gas 與現有 DUP*、SWAP* 相同，都是 3。

## 5. 使用 EXCHANGE 的案例分析
- EXCHANGE 可以一次交換堆疊中的兩個值，常比多次 SWAPN 更有效率。
- 若想把 top|A|B|C| 改成 A|C|B，只需一個 EXCHANGE 就能完成。

## 6. 測試與驗證
- 如果堆疊位置不夠，像是要複製不存在的值，就會失敗。
- Gas 不足或堆疊溢出，同樣會導致指令失敗。
- 正確行為：DUPN 是把某個值複製到頂端；SWAPN 與 EXCHANGE 只交換，不改變堆疊長度。

## 7. 結論
- EIP-663 讓編譯器更簡單，也提供更強大的堆疊操作方式。
- 適用場景更多，合約的設計也能更靈活。

